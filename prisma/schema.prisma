// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// =============================================
// USER & AUTHENTICATION
// =============================================

model User {
  id          String    @id @default(cuid())
  clerkId     String    @unique
  email       String    @unique
  firstName   String
  lastName    String
  username    String?   @unique
  avatar      String?
  bio         String?   @db.Text
  phone       String?
  role        Role      @default(MEMBER)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  blogPosts       BlogPost[]
  comments        Comment[]
  forumThreads    ForumThread[]
  forumReplies    ForumReply[]
  donations       Donation[]
  fines           Fine[]
  familyMembers   FamilyMember[]   @relation("AddedByUser")
  analyticsEvents AnalyticsEvent[]
  testimonials    Testimonial[]
  bookmarks       Bookmark[]
  newsBookmarks   NewsBookmark[]
  notifications   Notification[]
  likes           Like[]
  forumVotes      ForumVote[]
  pollVotes       PollVote[]

  @@index([clerkId])
  @@index([email])
  @@index([role])
}

enum Role {
  GUEST
  MEMBER
  MODERATOR
  ADMIN
  SUPER_ADMIN
}

// =============================================
// FAMILY TREE
// =============================================

model FamilyMember {
  id         String    @id @default(cuid())
  firstName  String
  lastName   String
  dateOfBirth DateTime?
  dateOfDeath DateTime?
  gender     Gender
  photo      String?
  bio        String?   @db.Text
  familyClan String?
  generation Int?
  isAlive    Boolean   @default(true)
  isApproved Boolean   @default(false)
  approvedAt DateTime?
  approvedBy String?

  // Self-referential relations
  fatherId       String?
  father         FamilyMember?  @relation("FatherChildren", fields: [fatherId], references: [id])
  fatherChildren FamilyMember[] @relation("FatherChildren")

  motherId       String?
  mother         FamilyMember?  @relation("MotherChildren", fields: [motherId], references: [id])
  motherChildren FamilyMember[] @relation("MotherChildren")

  spouseId String?
  spouse   FamilyMember?  @relation("SpouseRelation", fields: [spouseId], references: [id])
  spouseOf FamilyMember[] @relation("SpouseRelation")

  // Who added this member
  addedByUserId String
  addedByUser   User @relation("AddedByUser", fields: [addedByUserId], references: [id])

  // Life events
  lifeEvents LifeEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([familyClan])
  @@index([isApproved])
  @@index([addedByUserId])
}

model LifeEvent {
  id             String        @id @default(cuid())
  type           LifeEventType
  date           DateTime
  description    String?
  location       String?
  familyMemberId String
  familyMember   FamilyMember  @relation(fields: [familyMemberId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum LifeEventType {
  BIRTH
  MARRIAGE
  GRADUATION
  ACHIEVEMENT
  DEATH
  OTHER
}

// =============================================
// BLOG SYSTEM
// =============================================

model BlogPost {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  excerpt     String?    @db.VarChar(500)
  content     String     @db.Text
  coverImage  String?
  status      PostStatus @default(DRAFT)
  isFeatured  Boolean    @default(false)
  readingTime Int?
  views       Int        @default(0)
  publishedAt DateTime?
  scheduledAt DateTime?

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  categoryId String?
  category   BlogCategory? @relation(fields: [categoryId], references: [id])

  tags      BlogPostTag[]
  comments  Comment[]
  likes     Like[]
  bookmarks Bookmark[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId])
  @@index([status, publishedAt])
  @@index([categoryId])
  @@index([isFeatured])
  @@index([slug])
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  SCHEDULED
}

model BlogCategory {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  color       String?    @default("#6366f1")
  icon        String?
  sortOrder   Int        @default(0)
  posts       BlogPost[]
  createdAt   DateTime   @default(now())
}

model BlogTag {
  id    String        @id @default(cuid())
  name  String        @unique
  slug  String        @unique
  posts BlogPostTag[]
}

model BlogPostTag {
  postId String
  tagId  String
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag    BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
}

model Comment {
  id       String  @id @default(cuid())
  content  String  @db.Text
  isPinned Boolean @default(false)
  isEdited Boolean @default(false)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  postId String
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  likes   Like[]
  reports Report[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId, createdAt])
  @@index([parentId])
}

model Like {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  postId    String?
  commentId String?
  post      BlogPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment   Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([postId])
  @@index([commentId])
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String
  post      BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
}

// =============================================
// FORUM SYSTEM
// =============================================

model ForumCategory {
  id            String        @id @default(cuid())
  name          String        @unique
  slug          String        @unique
  description   String?
  icon          String?
  color         String?       @default("#6366f1")
  sortOrder     Int           @default(0)
  isLocked      Boolean       @default(false)
  minRoleToPost Role          @default(MEMBER)
  threads       ForumThread[]
  createdAt     DateTime      @default(now())
}

model ForumThread {
  id       String       @id @default(cuid())
  title    String
  slug     String       @unique
  content  String       @db.Text
  isPinned Boolean      @default(false)
  isLocked Boolean      @default(false)
  status   ThreadStatus @default(OPEN)
  views    Int          @default(0)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  categoryId String
  category   ForumCategory @relation(fields: [categoryId], references: [id])

  tags    ForumThreadTag[]
  replies ForumReply[]
  polls   ForumPoll[]
  reports Report[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId, isPinned, createdAt])
  @@index([authorId])
  @@index([status])
}

enum ThreadStatus {
  OPEN
  RESOLVED
  CLOSED
}

model ForumReply {
  id         String  @id @default(cuid())
  content    String  @db.Text
  isSolution Boolean @default(false)
  isEdited   Boolean @default(false)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  threadId String
  thread   ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  parentId String?
  parent   ForumReply?  @relation("ReplyNesting", fields: [parentId], references: [id], onDelete: Cascade)
  children ForumReply[] @relation("ReplyNesting")

  votes   ForumVote[]
  reports Report[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([threadId, createdAt])
  @@index([parentId])
}

model ForumVote {
  id        String     @id @default(cuid())
  value     Int // +1 or -1
  userId    String
  user      User       @relation(fields: [userId], references: [id])
  replyId   String
  reply     ForumReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())

  @@unique([userId, replyId])
}

model ForumTag {
  id      String           @id @default(cuid())
  name    String           @unique
  slug    String           @unique
  threads ForumThreadTag[]
}

model ForumThreadTag {
  threadId String
  tagId    String
  thread   ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  tag      ForumTag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([threadId, tagId])
}

model ForumPoll {
  id            String            @id @default(cuid())
  question      String
  isMultiChoice Boolean           @default(false)
  threadId      String
  thread        ForumThread       @relation(fields: [threadId], references: [id], onDelete: Cascade)
  options       ForumPollOption[]
  createdAt     DateTime          @default(now())
}

model ForumPollOption {
  id     String     @id @default(cuid())
  text   String
  pollId String
  poll   ForumPoll  @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes  PollVote[]
}

model PollVote {
  id       String          @id @default(cuid())
  userId   String
  user     User            @relation(fields: [userId], references: [id])
  optionId String
  option   ForumPollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([userId, optionId])
}

// =============================================
// NEWS SYSTEM
// =============================================

model NewsArticle {
  id         String       @id @default(cuid())
  title      String
  slug       String       @unique
  content    String?      @db.Text
  excerpt    String?      @db.VarChar(500)
  coverImage String?
  source     NewsSource
  sourceUrl  String?
  sourceName String?
  category   NewsCategory
  isFeatured Boolean      @default(false)
  views      Int          @default(0)

  bookmarks NewsBookmark[]

  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category, publishedAt])
  @@index([source])
}

model NewsBookmark {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  articleId String
  article   NewsArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([userId, articleId])
}

enum NewsSource {
  LOCAL
  EXTERNAL
}

enum NewsCategory {
  LOCAL
  STATE
  NATIONAL
  INTERNATIONAL
}

// =============================================
// PAYMENT & DONATION SYSTEM
// =============================================

model Donation {
  id              String         @id @default(cuid())
  amount          Decimal        @db.Decimal(10, 2)
  currency        String         @default("INR")
  message         String?        @db.Text
  isAnonymous     Boolean        @default(false)
  isRecurring     Boolean        @default(false)
  recurringFreq   String? // "monthly" | "yearly"
  paymentMethod   String?
  transactionId   String?        @unique
  razorpayOrderId String?        @unique
  status          PaymentStatus  @default(PENDING)
  receiptUrl      String?

  donorId String
  donor   User   @relation(fields: [donorId], references: [id])

  campaignId String?
  campaign   DonationCampaign? @relation(fields: [campaignId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([donorId, createdAt])
  @@index([campaignId])
  @@index([status])
}

model DonationCampaign {
  id           String         @id @default(cuid())
  title        String
  slug         String         @unique
  description  String         @db.Text
  coverImage   String?
  targetAmount Decimal        @db.Decimal(10, 2)
  raisedAmount Decimal        @db.Decimal(10, 2) @default(0)
  donorCount   Int            @default(0)
  status       CampaignStatus @default(ACTIVE)
  deadline     DateTime?
  updates      CampaignUpdate[]
  donations    Donation[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([status])
}

model CampaignUpdate {
  id         String           @id @default(cuid())
  title      String
  content    String           @db.Text
  campaignId String
  campaign   DonationCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now())
}

enum CampaignStatus {
  ACTIVE
  COMPLETED
  EXPIRED
  CANCELLED
}

model Fine {
  id                String     @id @default(cuid())
  amount            Decimal    @db.Decimal(10, 2)
  reason            String     @db.Text
  dueDate           DateTime
  status            FineStatus @default(PENDING)
  paidAt            DateTime?
  transactionId     String?
  razorpayOrderId   String?
  isDisputed        Boolean    @default(false)
  disputeNote       String?    @db.Text
  disputeResolvedAt DateTime?
  disputeResolution String?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  assignedBy String // clerkId of admin who assigned
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId, status])
  @@index([status, dueDate])
}

enum FineStatus {
  PENDING
  PAID
  OVERDUE
  DISPUTED
  WAIVED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// =============================================
// ANALYTICS
// =============================================

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String
  pageUrl    String?
  metadata   Json?
  sessionId  String?
  deviceType String?
  browser    String?
  ipAddress  String?
  duration   Int? // time on page in seconds

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([pageUrl, createdAt])
  @@index([createdAt])
}

// =============================================
// CONTENT MODERATION
// =============================================

model Report {
  id          String       @id @default(cuid())
  reason      String
  description String?      @db.Text
  status      ReportStatus @default(PENDING)
  resolvedAt  DateTime?
  resolvedBy  String?

  reporterId String
  // Polymorphic: one of these will be set
  commentId  String?
  comment    Comment?     @relation(fields: [commentId], references: [id], onDelete: Cascade)
  threadId   String?
  thread     ForumThread? @relation(fields: [threadId], references: [id], onDelete: Cascade)
  replyId    String?
  reply      ForumReply?  @relation(fields: [replyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([status])
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
  DISMISSED
}

// =============================================
// MISCELLANEOUS
// =============================================

model Testimonial {
  id         String  @id @default(cuid())
  content    String  @db.Text
  rating     Int     @default(5) // 1-5
  isApproved Boolean @default(false)
  isFeatured Boolean @default(false)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isApproved, isFeatured])
}

model Notification {
  id      String  @id @default(cuid())
  title   String
  message String
  type    String // COMMENT, REPLY, FINE, CAMPAIGN, APPROVAL, ROLE_CHANGE
  isRead  Boolean @default(false)
  link    String?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId, isRead, createdAt])
}

model ContactSubmission {
  id         String        @id @default(cuid())
  name       String
  email      String
  subject    String
  message    String        @db.Text
  attachment String? // S3 URL
  status     ContactStatus @default(NEW)
  resolvedAt DateTime?
  resolvedBy String?
  createdAt  DateTime      @default(now())

  @@index([status, createdAt])
}

enum ContactStatus {
  NEW
  IN_PROGRESS
  RESOLVED
}

model SiteSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt
}
